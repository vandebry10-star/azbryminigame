<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Azbry Chess</title>
<link href="assets/css/azbry.css" rel="stylesheet"/>

<style>
:root{ --piece-size-min:22px; --piece-size-vw:6.6vw; --piece-size-max:52px; }

.page-wrap{max-width:1100px;margin:0 auto;padding:20px 14px 120px}
.header-line{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:6px 0 16px}
.h-sub{color:var(--muted,#9aa4b2);font-weight:800;font-size:12px;letter-spacing:.25px;text-transform:uppercase}
.h-title{margin:2px 0 0;font-weight:800;font-size:clamp(22px,4vw,34px)}
.mode-pill{padding:8px 14px;border-radius:999px;font-weight:800;background:linear-gradient(180deg,var(--accent,#b8ff9a),var(--accent2,#8ee887));color:#0b0d10;border:0;box-shadow:0 6px 22px rgba(184,255,154,.25)}
.btn-ghost{background:transparent;color:var(--ink,#e6e8ec);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;font-weight:800}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(184,255,154,.08);border:1px solid rgba(184,255,154,.25);color:#dfffe0;font-weight:800;font-size:12px}

.chess-shell{display:grid;grid-template-columns:1fr;gap:16px;align-items:start}
.board-card,.side-card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 60%),var(--panel,#111418);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
.board-card{padding:16px}
.side-card{padding:16px}

.board-wrap{display:grid;place-items:center}
.board{
  width:min(92vw,700px); aspect-ratio:1/1;
  display:grid;grid-template-columns:repeat(8,1fr);
  border-radius:14px;overflow:hidden;
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset,0 20px 60px rgba(184,255,154,.07);
  background:#0e1013
}
.square{position:relative;display:grid;place-items:center;
  font-size:clamp(var(--piece-size-min),var(--piece-size-vw),var(--piece-size-max));
  line-height:1;user-select:none}
.square.dark{background:#151a1f} .square.light{background:#0f1317}
.square.sel{box-shadow:inset 0 0 0 2px rgba(184,255,154,.65)}
.square.move{box-shadow:inset 0 0 0 2px rgba(184,255,154,.35)}
.square .dot{width:12px;height:12px;border-radius:50%;background:rgba(184,255,154,.75);box-shadow:0 0 12px rgba(184,255,154,.8)}
.coord{position:absolute;font-size:12px;color:rgba(255,255,255,.28)}
.coord.file{bottom:6px;right:8px} .coord.rank{top:6px;left:8px}

.brilliant{position:absolute;right:6px;top:6px;background:rgba(184,255,154,.2);
  border:1px solid rgba(184,255,154,.5);color:#dfffe0;font-weight:900;font-size:12px;
  padding:2px 6px;border-radius:10px;letter-spacing:.3px;transform:translateY(-6px);opacity:0;animation:pop .45s ease-out forwards}
@keyframes pop{to{transform:none;opacity:1}}

.panel-grid{display:grid;gap:12px}
.kv{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid rgba(255,255,255,.06);border-radius:12px;background:rgba(255,255,255,.02)}
.kv b{font-weight:800}
.moves{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:#cbd5e1;line-height:1.5;white-space:pre-wrap}

@media (min-width:960px){ .chess-shell{grid-template-columns:minmax(0,1fr) 340px} .side-card{position:sticky;top:90px}}

/* Board-only */
.board-only .side-card,.board-only .btn-full{display:none!important}
.board-only .board-card{padding:8px}
.board-only .board{width:min(96vw,900px)}
</style>
</head>
<body>
<div class="page-wrap">
  <header class="header-line">
    <div>
      <div class="h-sub">AZBRY-MD • BOARD</div>
      <h1 class="h-title">Azbry Chess</h1>
    </div>
    <div class="toolbar">
      <button class="mode-pill" id="btnMode">vs Human (Local)</button>
      <button class="btn-ghost btn-full" id="btnBoardOnly">Board Only</button>
      <a class="btn-ghost" href="index.html">Kembali</a>
    </div>
  </header>

  <div class="chess-shell">
    <section class="board-card">
      <div class="board-wrap">
        <div id="board" class="board" aria-label="Papan Catur"></div>
      </div>
    </section>

    <aside class="side-card">
      <div class="panel-grid">
        <div class="kv"><span><b>Giliran</b></span><span id="turnLabel">Putih</span></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnReset" class="mode-pill">Mulai Ulang</button>
          <button id="btnUndo" class="btn-ghost">Undo 1 Langkah</button>
        </div>
        <div>
          <div class="h-sub" style="margin:8px 0 6px">Riwayat</div>
          <div id="moves" class="moves">—</div>
        </div>
        <small style="color:#9eb39f">Promosi otomatis → Queen. (Tanpa castling & en passant.)</small>
      </div>
    </aside>
  </div>
</div>

<script>
/* ========== ICON & NILAI ========== */
const ICON={P:'♙',N:'♘',B:'♗',R:'♖',Q:'♕',K:'♔',p:'♟',n:'♞',b:'♝',r:'♜',q:'♛',k:'♚'};
const VAL={P:1,N:3,B:3,R:5,Q:9,K:100,p:1,n:3,b:3,r:5,q:9,k:100};

let board=[], turn='w', sel=null, legal=[], history=[];
let vsAI=false; // false: human vs human, true: black = AI (Easy)

const BOARD=document.getElementById('board');
const MOVES=document.getElementById('moves');

/* ===== START POS ===== */
function startPos(){
  const rows=['rnbqkbnr','pppppppp','........','........','........','........','PPPPPPPP','RNBQKBNR'];
  board=rows.map(r=>r.split(''));
  turn='w'; sel=null; legal=[]; history=[];
  MOVES.textContent='—';
  draw(); updateTurn();
}

/* ===== DRAW ===== */
function draw(){
  BOARD.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const dv=document.createElement('div');
      dv.className='square '+((r+c)%2?'dark':'light');
      dv.dataset.r=r; dv.dataset.c=c;
      const p=board[r][c]; if(p!=='.') dv.textContent=ICON[p]||'';
      if(r===7){const f=document.createElement('span');f.className='coord file';f.textContent='abcdefgh'[c];dv.appendChild(f)}
      if(c===0){const k=document.createElement('span');k.className='coord rank';k.textContent=8-r;dv.appendChild(k)}
      dv.onclick=onSquare;
      BOARD.appendChild(dv);
    }
  }
}

/* ===== HELPERS ===== */
const inb=(r,c)=>r>=0&&r<8&&c>=0&&c<8;
const isW=p=>/[PNBRQK]/.test(p), isB=p=>/[pnbrqk]/.test(p);
const sideOf=p=>isW(p)?'w':(isB(p)?'b':'.');

/* ===== GEN MOVES (pseudolegal) ===== */
function genPseudo(r,c){
  const p=board[r][c]; if(p=='.') return [];
  const side=sideOf(p); const mv=[];
  const slide=(dirs)=>{for(const[dr,dc]of dirs){let rr=r+dr,cc=c+dc;while(inb(rr,cc)){const t=board[rr][cc];if(t=='.'){mv.push({r:rr,c:cc,cap:false})}else{ if(sideOf(t)!==side) mv.push({r:rr,c:cc,cap:true}); break } rr+=dr;cc+=dc }}};
  switch(p.toLowerCase()){
    case 'p':{const dir=isW(p)?-1:1; const start=isW(p)?6:1;
      if(inb(r+dir,c)&&board[r+dir][c]=='.') mv.push({r:r+dir,c,cap:false});
      if(r===start&&board[r+dir][c]=='.'&&board[r+2*dir][c]=='.') mv.push({r:r+2*dir,c,cap:false});
      for(const dc of[-1,1]){const rr=r+dir,cc=c+dc;if(inb(rr,cc)&&board[rr][cc]!='.'&&sideOf(board[rr][cc])!==side) mv.push({r:rr,c:cc,cap:true})}
      break;}
    case 'n':{const d=[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]];
      for(const[dr,dc]of d){const rr=r+dr,cc=c+dc;if(!inb(rr,cc))continue;const t=board[rr][cc];if(t=='.'||sideOf(t)!==side) mv.push({r:rr,c:cc,cap:t!='.'})} break;}
    case 'b': slide([[1,1],[1,-1],[-1,1],[-1,-1]]); break;
    case 'r': slide([[1,0],[-1,0],[0,1],[0,-1]]); break;
    case 'q': slide([[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]); break;
    case 'k': for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(!dr&&!dc)continue;const rr=r+dr,cc=c+dc;if(!inb(rr,cc))continue;const t=board[rr][cc];if(t=='.'||sideOf(t)!==side) mv.push({r:rr,c:cc,cap:t!='.'})} break;
  }
  // jangan boleh target king (biar "raja dimakan" nggak terjadi)
  const enemyKing = side==='w'?'k':'K';
  return mv.filter(m=>board[m.r][m.c]!==enemyKing);
}

/* ===== KING CHECK ===== */
function kingPos(side){
  const k = side==='w'?'K':'k';
  for(let r=0;r<8;r++)for(let c=0;c<8;c++) if(board[r][c]===k) return {r,c};
  return null;
}
function isSquareAttacked(r,c,bySide){
  // brute: lihat semua bidak bySide punya gerakan ke (r,c)
  for(let rr=0;rr<8;rr++)for(let cc=0;cc<8;cc++){
    const p=board[rr][cc]; if(p==='.') continue;
    if(bySide==='w' && !isW(p)) continue;
    if(bySide==='b' && !isB(p)) continue;
    const moves=genPseudo(rr,cc);
    if(moves.some(m=>m.r===r && m.c===c)) return true;
  }
  return false;
}
function inCheck(side){
  const k=kingPos(side); if(!k) return false;
  const enemy = side==='w'?'b':'w';
  return isSquareAttacked(k.r,k.c,enemy);
}

/* ===== LEGAL MOVES (filter self-check) ===== */
function genLegal(r,c){
  const p=board[r][c]; if(p==='.') return [];
  const side=sideOf(p); if(side!==turn) return [];
  const out=[];
  for(const m of genPseudo(r,c)){
    const snap=board[m.r][m.c]; const from=board[r][c];
    board[m.r][m.c]=from; board[r][c]='.';
    const ok=!inCheck(side);
    board[r][c]=from; board[m.r][m.c]=snap;
    if(ok) out.push(m);
  }
  return out;
}
function allLegal(side){
  const acc=[];
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=board[r][c]; if(p==='.') continue;
    if(side==='w' && !isW(p)) continue; if(side==='b' && !isB(p)) continue;
    const ms = (side===turn)?genLegal(r,c):filterSelf(r,c,genPseudo(r,c),side);
    for(const m of ms) acc.push({from:{r,c}, to:{r:m.r,c:m.c}, cap:m.cap, piece:p});
  }
  return acc;
  function filterSelf(r,c,moves,side){
    const o=[];
    for(const m of moves){
      const snap=board[m.r][m.c]; const from=board[r][c];
      board[m.r][m.c]=from; board[r][c]='.';
      const ok=!inCheck(side);
      board[r][c]=from; board[m.r][m.c]=snap;
      if(ok) o.push(m);
    }
    return o;
  }
}

/* ===== MOVE APPLY ===== */
function doMove(r1,c1,r2,c2){
  const piece=board[r1][c1]; const target=board[r2][c2];
  let promo=null;
  if(piece==='P'&&r2===0) promo='Q';
  if(piece==='p'&&r2===7) promo='q';
  board[r2][c2]=promo?promo:piece; board[r1][c1]='.';
  const rec={from:{r:r1,c:c1},to:{r:r2,c:c2},piece,captured:target,promo};
  history.push(rec);
  draw(); logMove(rec);

  // Brilliant (!!): capture gain >=3 atau memberi check
  showBrilliantIfAny(rec, sideOf(piece));

  // switch turn, lalu cek end game
  turn=(turn==='w')?'b':'w'; updateTurn();
  const mateInfo = checkEndGame();
  if(mateInfo){ announce(mateInfo.text); }
  else if(vsAI && turn==='b'){ setTimeout(aiMoveEasy, 180); }
}
function logMove(m){
  const f='abcdefgh'; const from=f[m.from.c]+(8-m.from.r); const to=f[m.to.c]+(8-m.to.r);
  const cap=(m.captured&&m.captured!=='.')?'x':'–'; const promo=m.promo?('='+m.promo.toUpperCase()):'';
  const ply=history.length; const line=`${ply}. ${from} ${cap} ${to}${promo}`;
  MOVES.textContent = (MOVES.textContent==='—') ? line : MOVES.textContent+'\n'+line;
  MOVES.scrollTop=MOVES.scrollHeight;
}
function updateTurn(){ document.getElementById('turnLabel').textContent = (turn==='w'?'Putih':'Hitam'); }

/* ===== CLICK ===== */
function onSquare(ev){
  const r=+ev.currentTarget.dataset.r, c=+ev.currentTarget.dataset.c, p=board[r][c];

  if(!sel){
    if(p!=='.' && ((turn==='w'&&isW(p))||(turn==='b'&&isB(p)))){
      sel={r,c}; legal=genLegal(r,c); markSel();
    }
    return;
  }
  if(sel.r===r&&sel.c===c){ clearSel(); return; }

  const mv=legal.find(m=>m.r===r&&m.c===c);
  if(mv){ doMove(sel.r,sel.c,r,c); clearSel(); }
  else{
    if(p!=='.' && ((turn==='w'&&isW(p))||(turn==='b'&&isB(p)))){
      sel={r,c}; legal=genLegal(r,c); markSel();
    } else clearSel();
  }
}
function markSel(){
  clearSel();
  BOARD.children[sel.r*8+sel.c].classList.add('sel');
  for(const m of legal){
    const el=BOARD.children[m.r*8+m.c]; el.classList.add('move');
    const dot=document.createElement('div'); dot.className='dot'; el.appendChild(dot);
  }
}
function clearSel(){
  [...BOARD.children].forEach(e=>{e.classList.remove('sel','move'); const d=e.querySelector('.dot'); if(d)d.remove();});
  sel=null; legal=[];
}

/* ===== BRILLIANT (!!) ===== */
function showBrilliantIfAny(last, moverSide){
  let brilliant=false;
  const gain=(last.captured&&last.captured!=='.')?(VAL[last.captured]-VAL[last.piece]):0;
  if(gain>=3) brilliant=true;
  if(!brilliant && (!last.captured||last.captured==='.') ){
    // apakah memberi check?
    const enemy=moverSide==='w'?'b':'w';
    if(inCheck(enemy)) brilliant=true;
  }
  if(brilliant){
    const idx=last.to.r*8+last.to.c, sq=BOARD.children[idx];
    const b=document.createElement('div'); b.className='brilliant'; b.textContent='!!';
    sq.appendChild(b);
  }
}

/* ===== END GAME ===== */
function checkEndGame(){
  const side=turn;
  const moves=allLegal(side);
  if(moves.length>0){
    if(inCheck(side)) return {text:'Check!'}; // hanya info
    return null;
  }
  if(inCheck(side)){
    const winner=(side==='w')?'Hitam':'Putih';
    return {text:`Checkmate • ${winner} menang`};
  } else {
    return {text:'Stalemate • Seri'};
  }
}
function announce(t){ // ringkas: tampilkan di riwayat
  MOVES.textContent += `\n— ${t}`;
  MOVES.scrollTop=MOVES.scrollHeight;
}

/* ===== AI EASY (BLACK) ===== */
function aiMoveEasy(){
  if(turn!=='b' || !vsAI) return;
  const moves=allLegal('b');
  if(!moves.length){ const info=checkEndGame(); if(info) announce(info.text); return; }
  // pilih capture terbaik, kalau nggak ada -> random
  let best=null, bestGain=-1;
  for(const m of moves){
    const gain = m.cap ? (VAL[board[m.to.r][m.to.c]] - VAL[m.piece]) : -0.1;
    if(gain>bestGain){ bestGain=gain; best=m; }
  }
  const pick = best || moves[Math.floor(Math.random()*moves.length)];
  doMove(pick.from.r,pick.from.c,pick.to.r,pick.to.c);
}

/* ===== UI ===== */
document.getElementById('btnReset').onclick=startPos;
document.getElementById('btnUndo').onclick=function(){
  const m=history.pop(); if(!m) return;
  board[m.from.r][m.from.c]=m.piece; board[m.to.r][m.to.c]=(m.captured&&m.captured!=='.')?m.captured:'.';
  draw();
  turn=(turn==='w')?'b':'w'; updateTurn();
  const lines=MOVES.textContent.split('\n'); lines.pop(); MOVES.textContent=lines.length?lines.join('\n'):'—';
};
document.getElementById('btnBoardOnly').onclick=()=>document.body.classList.toggle('board-only');
document.getElementById('btnMode').onclick=function(){
  vsAI=!vsAI;
  this.textContent = vsAI? 'vs AI (Easy)' : 'vs Human (Local)';
  startPos();
};

/* boot */
startPos();
</script>
</body>
</html>
