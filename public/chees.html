<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Azbry Chess</title>
<link rel="stylesheet" href="assets/css/azbry.css">
<style>
/* --- Komponen lokal halaman ini --- */
.wrap{max-width:1100px;margin:0 auto;padding:22px 16px 120px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.title .eyebrow{font-weight:800;color:var(--muted);letter-spacing:.3px;font-size:12px}
.title h1{margin:.25rem 0 .5rem;font-weight:800}
.mode{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:rgba(184,255,154,.1);border:1px solid rgba(184,255,154,.2);font-weight:800}
.grid{display:grid;grid-template-columns: 1fr minmax(300px,360px);gap:16px}

/* Board shell */
.board-wrap{
  display:flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,255,255,.06);border-radius:18px;
  background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
  box-shadow: var(--shadow);
  padding:12px;
  min-height:360px;
}
.board{
  position:relative;
  width:min(80vw, 640px);
  height:min(80vw, 640px);
  aspect-ratio:1/1;
  border-radius:14px;
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 20px 60px rgba(0,0,0,.45);
  --cell: calc(100% / 8);
}

/* cells */
.cell{
  position:absolute;inset:auto auto;
  width:var(--cell);height:var(--cell);
  display:grid;place-items:center;
  font-size:calc(var(--cell) * .62);
  user-select:none;-webkit-user-select:none;
  transition:background-color .12s ease, transform .08s ease;
}
.dark{background:#0f1318}
.light{background:#141920}
.cell:nth-child(odd).row-even.light{background:#0f1318}
.cell:nth-child(odd).row-even.dark{background:#141920}

/* piece */
.p{filter:drop-shadow(0 2px 8px rgba(0,0,0,.45))}
.w{color:#eaf0f6} .b{color:#cfe9d0;opacity:.95}
.pick{outline:2px solid rgba(184,255,154,.55);outline-offset:-3px}
.move{box-shadow: inset 0 0 0 2px rgba(184,255,154,.45)}
.capture{background:linear-gradient(180deg,rgba(255,75,75,.18),transparent)}

/* side panel */
.side{
  border:1px solid rgba(255,255,255,.06);border-radius:18px;
  background:var(--panel);box-shadow:var(--shadow);padding:14px;
}
.row{display:flex;align-items:center;justify-content:space-between;margin:6px 0}
.badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);font-weight:800}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 10px}
.log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size:13px;border-radius:12px;background:#0d1014;border:1px solid rgba(255,255,255,.06);padding:10px;height:160px;overflow:auto}
small.meta{color:var(--muted)}

/* --- Animasi Full Board (tambahan) --- */
.board, .board-wrap, header, .side, .azbry-footer { transition: all .28s ease; }
.side, .btns, .log, .meta, small.meta { transition: opacity .22s ease, transform .22s ease; }
.side, .btns, .log, .meta, small.meta { opacity:1; transform:translateY(0); }

.fullmode .side,
.fullmode .btns,
.fullmode .log,
.fullmode .meta,
.fullmode small.meta,
.fullmode .azbry-footer{
  opacity:0; transform:translateY(6px); pointer-events:none;
}
.fullmode header{justify-content:center;text-align:center}
.fullmode .board-wrap{justify-content:center}
.fullmode .board{
  width:min(95vw,95vh); height:min(95vw,95vh);
  --cell: calc(min(95vw,95vh) / 8);
  box-shadow: 0 0 0 1px rgba(184,255,154,.14), 0 30px 60px rgba(0,0,0,.35);
}
@media (prefers-reduced-motion:reduce){
  .board, .board-wrap, header, .side, .azbry-footer,
  .btns, .log, .meta, small.meta{transition:none !important}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <div class="eyebrow">AZBRY-MD • BOARD</div>
      <h1>Azbry Chess</h1>
    </div>
    <div class="mode">
      <span>vs Human (Local)</span>
    </div>
  </header>

  <section class="grid">
    <div class="board-wrap">
      <div class="board" id="board" aria-label="papan catur"></div>
    </div>

    <aside class="side">
      <div class="row"><div class="badge">Giliran</div><div id="turn">Putih</div></div>
      <div class="row"><div class="badge">Status</div><div id="status">Jalan</div></div>

      <div class="btns">
        <button class="btn" id="restart">Mulai Ulang</button>
        <button class="btn ghost" id="undo">Undo 1 Langkah</button>
        <button class="btn ghost" id="fullscreen">Mode Full Board</button>
      </div>

      <div class="meta" style="margin-top:6px;margin-bottom:6px;font-weight:800">Catatan</div>
      <p class="alert">Promotion otomatis jadi <b>Queen</b>. (Castling & en passant: belum)</p>

      <div class="meta" style="margin-top:10px;font-weight:800">Log Langkah</div>
      <div class="log" id="log"></div>
      <small class="meta">Klik bidak untuk melihat langkah yang sah (dasar). Klik petak tujuan untuk bergerak.</small>
    </aside>
  </section>
</div>

<script>
/* ====== Util & State ====== */
const boardEl = document.getElementById('board');
const logEl = document.getElementById('log');
const turnEl = document.getElementById('turn');
const statusEl = document.getElementById('status');

const initialFEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"; // mulai standar

// Unicode pieces
const U = {
  P:'♙', N:'♘', B:'♗', R:'♖', Q:'♕', K:'♔',
  p:'♟', n:'♞', b:'♝', r:'♜', q:'♛', k:'♚'
};

let board = fenToArray(initialFEN); // 8x8
let whiteTurn = true;
let sel = null;          // {r,c}
let moves = [];          // history untuk undo [{from,to,piece,captured,promo}]
renderBoard();

function fenToArray(fen){
  const rows = fen.split('/');
  return rows.map(r=>{
    const row=[];
    for(const ch of r){
      if(/\d/.test(ch)){ for(let i=0;i<Number(ch);i++) row.push(''); }
      else row.push(ch);
    }
    return row;
  });
}

function renderBoard(){
  boardEl.innerHTML='';
  const size = 8;
  const isEvenRow = (r)=> ((r%2)===0);
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cell = document.createElement('div');
      cell.className = 'cell ' + ((r+c)%2? 'dark':'light') + (isEvenRow(r)?' row-even':'');
      cell.style.left = `calc(var(--cell) * ${c})`;
      cell.style.top  = `calc(var(--cell) * ${r})`;
      cell.dataset.r=r; cell.dataset.c=c;
      const p = board[r][c];
      if(p){
        const span = document.createElement('span');
        span.className = 'p ' + (p===p.toUpperCase() ? 'w':'b');
        span.textContent = U[p];
        cell.appendChild(span);
      }
      cell.addEventListener('click', onCellClick);
      boardEl.appendChild(cell);
    }
  }
  turnEl.textContent = whiteTurn ? 'Putih' : 'Hitam';
}

function onCellClick(e){
  const r = +e.currentTarget.dataset.r;
  const c = +e.currentTarget.dataset.c;
  const piece = board[r][c];

  // memilih
  if(!sel){
    if(!piece) return;
    const isWhite = piece===piece.toUpperCase();
    if(isWhite !== whiteTurn) return;
    sel = {r,c};
    highlightMoves(r,c);
    e.currentTarget.classList.add('pick');
    return;
  }

  // jika klik petak yang sama: batal
  if(sel.r===r && sel.c===c){
    clearMarks(); sel=null; return;
  }

  // coba bergerak
  const legal = genMoves(sel.r, sel.c);
  if(legal.some(m=>m.r===r && m.c===c)){
    doMove(sel.r, sel.c, r, c);
    clearMarks(); sel=null;
    whiteTurn = !whiteTurn;
    renderBoard();
    statusEl.textContent='Jalan';
  }else{
    // reselect
    clearMarks(); sel=null;
    onCellClick(e);
  }
}

function clearMarks(){
  boardEl.querySelectorAll('.cell').forEach(c=>{
    c.classList.remove('pick','move','capture');
  });
}

function highlightMoves(r,c){
  clearMarks();
  const fromCell = qCell(r,c);
  if(fromCell) fromCell.classList.add('pick');
  const legal = genMoves(r,c);
  legal.forEach(m=>{
    const cell = qCell(m.r,m.c);
    if(!cell) return;
    if(board[m.r][m.c]) cell.classList.add('capture');
    else cell.classList.add('move');
  });
}

function qCell(r,c){ return boardEl.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`); }

function inside(r,c){ return r>=0 && r<8 && c>=0 && c<8; }

function genMoves(r,c){
  const res=[];
  const p = board[r][c];
  if(!p) return res;
  const white = p===p.toUpperCase();
  const dir = white ? -1 : 1;

  const add = (rr,cc)=>{
    if(!inside(rr,cc)) return false;
    const t = board[rr][cc];
    if(!t){ res.push({r:rr,c:cc}); return true; }
    if( (t===t.toUpperCase()) !== white ){ res.push({r:rr,c:cc}); }
    return false;
  };

  switch(p.toLowerCase()){
    case 'p':{
      // maju
      if(inside(r+dir,c) && !board[r+dir][c]){ res.push({r:r+dir,c}); 
        const start = white ? 6:1;
        if(r===start && !board[r+2*dir][c]) res.push({r:r+2*dir,c});
      }
      // makan
      [[dir,-1],[dir,1]].forEach(([dr,dc])=>{
        const rr=r+dr, cc=c+dc;
        if(inside(rr,cc) && board[rr][cc]){
          const enemyWhite = board[rr][cc]===board[rr][cc].toUpperCase();
          if(enemyWhite !== white) res.push({r:rr,c:cc});
        }
      });
      break;
    }
    case 'n':{
      [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>{
        const rr=r+dr, cc=c+dc;
        if(!inside(rr,cc)) return;
        const t=board[rr][cc];
        if(!t || (t===t.toUpperCase())!==white) res.push({r:rr,c:cc});
      });
      break;
    }
    case 'b': slide([[1,1],[1,-1],[-1,1],[-1,-1]]); break;
    case 'r': slide([[1,0],[-1,0],[0,1],[0,-1]]); break;
    case 'q': slide([[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]); break;
    case 'k':{
      [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc])=>{
        const rr=r+dr, cc=c+dc;
        if(!inside(rr,cc)) return;
        const t=board[rr][cc];
        if(!t || (t===t.toUpperCase())!==white) res.push({r:rr,c:cc});
      });
      break;
    }
  }
  function slide(dirs){
    for(const [dr,dc] of dirs){
      let rr=r+dr, cc=c+dc;
      while(inside(rr,cc)){
        const t=board[rr][cc];
        if(!t){ res.push({r:rr,c:cc}); }
        else{
          if((t===t.toUpperCase())!==white) res.push({r:rr,c:cc});
          break;
        }
        rr+=dr; cc+=dc;
      }
    }
  }
  return res;
}

function doMove(r1,c1,r2,c2){
  const piece = board[r1][c1];
  const captured = board[r2][c2] || '';
  // promotion
  let promo = '';
  if(piece.toLowerCase()==='p' && (r2===0 || r2===7)){
    promo = piece===piece.toUpperCase() ? 'Q' : 'q';
  }
  moves.push({from:{r:r1,c:c1}, to:{r:r2,c:c2}, piece, captured, promo});
  board[r1][c1] = '';
  board[r2][c2] = promo || piece;

  // log
  const files = ['a','b','c','d','e','f','g','h'];
  const ranks = ['8','7','6','5','4','3','2','1'];
  const icon = pieceIcon(piece);
  const txt = `${icon} ${files[c1]}${ranks[r1]} → ${files[c2]}${ranks[r2]}${promo? ' = Q':''}${captured? ' ×':''}`;
  appendLog(txt);
}

function pieceIcon(p){
  const base = p.toLowerCase();
  const map = {p:'♟',n:'♞',b:'♝',r:'♜',q:'♛',k:'♚'};
  return map[base]||'•';
}

function appendLog(t){
  const line = document.createElement('div');
  line.textContent = t;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

/* ====== Controls ====== */
document.getElementById('restart').onclick = ()=>{
  board = fenToArray(initialFEN);
  whiteTurn = true; sel=null; moves.length=0; logEl.innerHTML='';
  statusEl.textContent='Jalan';
  renderBoard();
};
document.getElementById('undo').onclick = ()=>{
  const m = moves.pop(); if(!m) return;
  board[m.from.r][m.from.c] = m.piece;
  board[m.to.r][m.to.c] = m.captured;
  whiteTurn = (m.piece===m.piece.toUpperCase()); // kembalikan giliran
  logEl.lastChild && logEl.removeChild(logEl.lastChild);
  renderBoard();
};

/* Full Board toggle */
const fullBtn = document.getElementById('fullscreen');
let full = false;
fullBtn.onclick = () => {
  full = !full;
  document.body.classList.toggle('fullmode', full);
  fullBtn.textContent = full ? 'Kembali ke Normal' : 'Mode Full Board';
  document.querySelector('.board-wrap')?.scrollIntoView({ behavior:'smooth', block:'center' });
};
</script>
</body>
</html>
